<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>Laplacian HD Boost</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; color: #0f0; font-family: sans-serif; overflow: hidden; }
        #launcher { position: fixed; inset: 0; background: #0a0a0a; z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .config-box { background: #1a1a1a; padding: 25px; border: 2px solid #0f0; border-radius: 15px; width: 100%; max-width: 400px; text-align: center; }
        .option { margin-bottom: 15px; text-align: left; }
        label { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        select, input[type="range"] { width: 100%; background: #000; color: #0f0; border: 1px solid #0f0; padding: 10px; margin-top: 5px; }
        #startBtn { width: 100%; background: #0f0; color: #000; border: none; padding: 18px; font-size: 1.1rem; font-weight: bold; border-radius: 10px; cursor: pointer; margin-top: 10px; }
        #startBtn:disabled { background: #050; color: #444; }
        
        /* Immersive Controls - Floating */
        #live-controls { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 30px; display: none; border: 1px solid rgba(0,255,0,0.3); }
        canvas { position: absolute; inset: 0; width: 100vw; height: 100vh; object-fit: cover; z-index: 1; display: none; }
        #webcam { display: none; }
    </style>
</head>
<body>

    <div id="launcher">
        <div class="config-box">
            <h2 style="margin-top:0; color:#fff;">HD CONFIG</h2>
            
            <div class="option">
                <label>Camera Quality</label>
                <select id="camRes">
                    <option value="1920">1080p (Highest Detail)</option>
                    <option value="1280" selected>720p (Balanced)</option>
                </select>
            </div>

            <div class="option">
                <label>Processing Scale (Chunking)</label>
                <select id="blockSize">
                    <option value="1">1:1 (Sharpest)</option>
                    <option value="1.5" selected>1.5:1 (Stable HD)</option>
                    <option value="2">2:1 (Smooth)</option>
                </select>
            </div>

            <div class="option">
                <label>Sensitivity Boost</label>
                <input type="range" id="sensSlider" min="10" max="100" value="40">
                <div style="font-size: 9px; text-align: center; color: #0f0;">Higher = More Edges/Bright</div>
            </div>

            <button id="startBtn" disabled onclick="goLive()">BOOT SENSOR</button>
            <p id="loading-msg" style="font-size: 10px; margin-top:10px; font-family: monospace;">LOADING ENGINES...</p>
        </div>
    </div>

    <div id="live-controls">
        <label style="color:#0f0; font-size: 10px;">LIVE SENSITIVITY</label>
        <input type="range" id="liveSens" min="10" max="100" value="40" oninput="syncSens(this.value)">
    </div>

    <video id="webcam" autoplay playsinline></video>
    <canvas id="outputCanvas"></canvas>

    <script>
        window.CONFIG = { camW: 1280, chunk: 1.5, thresh: 40 };

        function syncSens(val) { window.CONFIG.thresh = parseInt(val); }

        async function goLive() {
            window.CONFIG.camW = parseInt(document.getElementById('camRes').value);
            window.CONFIG.chunk = parseFloat(document.getElementById('blockSize').value);
            window.CONFIG.thresh = parseInt(document.getElementById('sensSlider').value);
            document.getElementById('liveSens').value = window.CONFIG.thresh;

            const doc = document.documentElement;
            if (doc.requestFullscreen) await doc.requestFullscreen();
            if (screen.orientation && screen.orientation.lock) await screen.orientation.lock('landscape').catch(()=>{});

            document.getElementById('launcher').style.display = 'none';
            document.getElementById('outputCanvas').style.display = 'block';
            document.getElementById('live-controls').style.display = 'block';

            const video = document.getElementById('webcam');
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { width: window.CONFIG.camW, facingMode: "user" }, 
                audio: false 
            });
            video.srcObject = stream;
        }

        function pythonReady() {
            document.getElementById('loading-msg').innerText = "SYSTEM READY";
            document.getElementById('startBtn').disabled = false;
        }
    </script>

    <script type="py" config='{"packages": ["opencv-python", "numpy"]}'>
        import cv2
        import numpy as np
        import time
        from js import document, window, requestAnimationFrame, pythonReady
        from pyodide.ffi import create_proxy

        pythonReady()
        video = document.getElementById("webcam")
        canvas = document.getElementById("outputCanvas")
        ctx = canvas.getContext("2d")

        def loop(t):
            if video.videoWidth > 0:
                chunk = window.CONFIG.chunk
                proc_w = int(video.videoWidth / chunk)
                proc_h = int(video.videoHeight / chunk)
                
                if canvas.width != proc_w:
                    canvas.width = proc_w
                    canvas.height = proc_h
                
                ctx.drawImage(video, 0, 0, proc_w, proc_h)
                img_data = ctx.getImageData(0, 0, proc_w, proc_h)
                
                frame = np.frombuffer(img_data.data.to_py(), dtype=np.uint8).reshape((proc_h, proc_w, 4))
                frame = cv2.flip(frame, 1)

                bgr = cv2.cvtColor(frame, cv2.COLOR_RGBA2BGR)
                gray = cv2.cvtColor(bgr, cv2.COLOR_BGR2GRAY)
                
                # 1. Sharpening to maintain crispness during chunking
                # 
                sharp_kernel = np.array([[-1,-1,-1], [-1,9,-1], [-1,-1,-1]])
                gray = cv2.filter2D(gray, -1, sharp_kernel)
                
                # 2. Laplacian Edge Detection
                # 
                edges = cv2.Laplacian(gray, cv2.CV_8U, ksize=5)
                
                # 3. Dynamic Thresholding (Sensitivity Boost)
                # Lower threshold means more subtle edges are detected (brighter output)
                # We subtract the slider value from 110 to invert the behavior (100 = high sens)
                sens_val = 110 - window.CONFIG.thresh
                _, thresh = cv2.threshold(edges, sens_val, 255, cv2.THRESH_BINARY)
                
                # 4. Color Masking
                mask = cv2.bitwise_and(bgr, bgr, mask=thresh)

                res_rgba = cv2.cvtColor(mask, cv2.COLOR_BGR2RGBA)
                img_ptr = window.ImageData.new(window.Uint8ClampedArray.new(res_rgba.tobytes()), proc_w, proc_h)
                ctx.putImageData(img_ptr, 0, 0)

            requestAnimationFrame(create_proxy(loop))

        loop(0)
    </script>
</body>
</html>
