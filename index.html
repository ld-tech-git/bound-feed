let currentPanel='A', isLibReady=false, currentFacingMode='user', activeConfig=null;
const video=document.getElementById('webcam');
const canvas=document.getElementById('outputCanvas');
const ctx=canvas.getContext('2d',{alpha:false});
const offCanvas=document.createElement('canvas');
const offCtx=offCanvas.getContext('2d');
const bootBtn=document.getElementById('bootBtn');
const status=document.getElementById('status');
const dashboard=document.getElementById('dashboard');
const fpsTag=document.getElementById('fps-tag');
const fsToggle=document.getElementById('fsToggle');
const logicB=document.getElementById('logicB');
const res=document.getElementById('res');

let worker=null;
let isProcessing=false;
let frameQueue=[];
let frames=0,lastTime=performance.now(),lastWorkerResponse=performance.now(),lastVideoTime=-1,healthInterval=null,fsTimer=null;

function initWorker(){
    if(worker) worker.terminate();
    worker=new Worker('./worker.js');
    worker.onmessage=e=>{
        if(e.data==="READY"){
            isLibReady=true;
            bootBtn.innerText="BOOT ENGINE";
            bootBtn.classList.add('ready');
            status.innerText="ONLINE";
            status.style.color="#0f0";
        }else if(e.data==="PONG"){
            lastWorkerResponse=performance.now();
        }else if(e.data==="RECOVER"){
            isProcessing=false;
        }else{
            ctx.putImageData(e.data,0,0);
            isProcessing=false;
            frames++;
            lastWorkerResponse=performance.now();
        }
    };
}
window.onload=()=>{initWorker();};

function switchPanel(p){
    currentPanel=p;
    document.getElementById('panelA').classList.toggle('active',p==='A');
    document.getElementById('panelB').classList.toggle('active',p==='B');
    document.getElementById('tabA').classList.toggle('active',p==='A');
    document.getElementById('tabB').classList.toggle('active',p==='B');
}

async function bootApp(){
    if(!isLibReady) return;
    isProcessing=false;
    if(video.srcObject) video.srcObject.getTracks().forEach(t=>t.stop());
    activeConfig={
        panel: currentPanel,
        scale: parseFloat(document.getElementById(currentPanel==='A'?'scaleA':'scaleB').value),
        blur: parseInt(document.getElementById(currentPanel==='A'?'blurA':'blurB').value),
        sense: parseFloat(document.getElementById(currentPanel==='A'?'senseA':'senseB').value),
        k: parseInt(document.getElementById('kSize').value),
        oldCode: (currentPanel==='B' && logicB.value==='old_code')
    };
    try{
        const stream=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:parseInt(res.value)}, facingMode:currentFacingMode}});
        video.srcObject=stream;
        video.onloadedmetadata=()=>{
            canvas.width=offCanvas.width=Math.floor(video.videoWidth/activeConfig.scale);
            canvas.height=offCanvas.height=Math.floor(video.videoHeight/activeConfig.scale);
            dashboard.style.display='none';
            canvas.style.display='block';
            fsToggle.style.display='block';
            fsToggle.className='pos-normal';
            if(!healthInterval) startHealthCheck();
            requestAnimationFrame(processLoop);
        };
    }catch(err){
        status.innerText="CAMERA ERROR";
    }
}

function startHealthCheck(){
    healthInterval=setInterval(()=>{
        if(!activeConfig||dashboard.style.display!=='none') return;
        const now=performance.now();
        const isVideoStalled=(video.currentTime===lastVideoTime);
        lastVideoTime=video.currentTime;
        if(now-lastWorkerResponse>3000 || isVideoStalled) isProcessing=false,worker.postMessage("PING");
        if(now-lastWorkerResponse>7000) initWorker(),bootApp();
    },2000);
}

function enqueueFrame(img){
    frameQueue.push(img);
    if(frameQueue.length>30) frameQueue=frameQueue.slice(-10);
    else if(frameQueue.length>10) frameQueue=frameQueue.slice(-5);
    else if(frameQueue.length>5) frameQueue=frameQueue.slice(-3);
}

function processLoop(){
    if(video.videoWidth>0 && activeConfig){
        offCtx.drawImage(video,0,0,offCanvas.width,offCanvas.height);
        enqueueFrame(offCtx.getImageData(0,0,offCanvas.width,offCanvas.height));
    }
    if(!isProcessing && frameQueue.length){
        isProcessing=true;
        const img=frameQueue.shift();
        worker.postMessage({...activeConfig, img, isFront:(currentFacingMode==='user')},[img.data.buffer]);
    }
    const now=performance.now();
    if(now-lastTime>=1000){
        fpsTag.innerText=`FPS: ${frames}`;
        frames=0;
        lastTime=now;
    }
    requestAnimationFrame(processLoop);
}

function toggleFullScreen(){
    if(!document.fullscreenElement) document.documentElement.requestFullscreen();
    else if(document.exitFullscreen) document.exitFullscreen();
}

document.addEventListener('fullscreenchange',()=>{
    if(document.fullscreenElement){
        fsToggle.classList.add('exit');
        fsToggle.classList.replace('pos-normal','pos-fs');
        clearTimeout(fsTimer);
        fsTimer=setTimeout(()=>fsToggle.style.display='none',3000);
    }else{
        fsToggle.classList.remove('exit');
        fsToggle.classList.replace('pos-fs','pos-normal');
        fsToggle.style.display='block';
    }
});

let touchX=0,taps=0,tapT;
window.addEventListener('touchstart',e=>{
    touchX=e.changedTouches[0].screenX;
    fsToggle.style.display='block';
    clearTimeout(fsTimer);
    if(document.fullscreenElement) fsTimer=setTimeout(()=>fsToggle.style.display='none',3000);

    taps++; clearTimeout(tapT);
    tapT=setTimeout(()=>{
        if(taps===2) fpsTag.style.display=(fpsTag.style.display==='none'?'block':'none');
        if(taps===3) currentFacingMode=(currentFacingMode==='user'?'environment':'user'),bootApp();
        if(taps===4){
            const l=document.createElement('a');
            l.download=`snap_${Date.now()}.png`;
            l.href=canvas.toDataURL();
            l.click();
        }
        taps=0;
    },300);
});
window.addEventListener('touchend',e=>{
    if(touchX-e.changedTouches[0].screenX>100) toggleRecording();
});
