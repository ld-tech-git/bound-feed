<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>Laplacian Pro | Dual Engine</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; color: #0f0; font-family: monospace; overflow: hidden; }
        #dashboard { position: fixed; inset: 0; z-index: 100; background: #0a0a0a; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow-y: auto; padding: 20px; }
        .box { border: 1px solid #0f0; padding: 20px; background: #1a1a1a; width: 360px; border-radius: 15px; box-shadow: 0 0 20px rgba(0,255,0,0.2); }
        
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .tab { flex: 1; padding: 10px; border: 1px solid #0f0; cursor: pointer; text-align: center; font-size: 12px; }
        .tab.active { background: #0f0; color: #000; font-weight: bold; }
        
        .panel { display: none; }
        .panel.active { display: block; }

        .opt { margin-bottom: 10px; text-align: left; position: relative; }
        label { font-size: 9px; color: #888; text-transform: uppercase; display: block; margin-bottom: 2px; }
        .val-display { position: absolute; right: 0; top: 0; font-size: 9px; color: #0f0; border: 1px solid #0f0; padding: 0 4px; }
        
        select, button { width: 100%; padding: 8px; background: #000; color: #0f0; border: 1px solid #0f0; font-family: monospace; border-radius: 5px; cursor: pointer; font-size: 12px; }
        #bootBtn { background: #0f0; color: #000; font-weight: bold; margin-top: 10px; }
        
        #fps-tag { position: fixed; top: 15px; right: 15px; z-index: 50; font-size: 14px; background: rgba(0,0,0,0.6); padding: 8px; border: 1px solid #0f0; display: none; pointer-events: none;}
        #outputCanvas { position: absolute; inset: 0; width: 100vw; height: 100vh; object-fit: cover; display: none; z-index: 1; }
        #webcam { display: none; }
        .status-bar { font-size: 9px; margin-top: 10px; color: #f00; text-align: center; }
    </style>
</head>
<body>

    <div id="dashboard">
        <div class="box">
            <h2 style="margin:0 0 10px 0; text-align: center; font-size: 1.1rem;">CORE SELECT</h2>
            
            <div class="tabs">
                <div id="tabA" class="tab active" onclick="switchPanel('A')">PANEL A<br><small>(Lap_Gau)</small></div>
                <div id="tabB" class="tab" onclick="switchPanel('B')">PANEL B<br><small>(Med_Blur)</small></div>
            </div>

            <div class="opt">
                <label>Resolution</label>
                <select id="resSelect">
                    <option value="1920">1080p (HD)</option>
                    <option value="1600">900p</option>
                    <option value="1280" selected>720p (Standard)</option>
                    <option value="1024">1024px</option>
                    <option value="800">800px</option>
                    <option value="640">480p (Fast)</option>
                    <option value="480">360p (Turbo)</option>
                </select>
            </div>

            <div id="panelA" class="panel active">
                <div class="opt"><label>A. Scale</label>
                    <select id="scaleA"><option value="1">1.0x</option><option value="1.2">1.2x</option><option value="1.5" selected>1.5x</option><option value="2">2.0x</option><option value="3">3.0x</option></select>
                </div>
                <div class="opt"><label>A. Gaussian Blur</label>
                    <select id="blurA"><option value="1">None</option><option value="3">3px</option><option value="5" selected>5px</option><option value="7">7px</option><option value="9">9px</option><option value="11">11px</option><option value="15">15px</option></select>
                </div>
                <div class="opt"><label>A. Otsu Sensitivity</label>
                    <select id="senseA"><option value="0.5">0.5</option><option value="0.7">0.7</option><option value="0.9" selected>0.9</option><option value="1.1">1.1</option><option value="1.3">1.3</option><option value="1.5">1.5</option></select>
                </div>
            </div>

            <div id="panelB" class="panel">
                <div class="opt"><label>B. Scale</label>
                    <select id="scaleB"><option value="1">1.0x</option><option value="1.5">1.5x</option><option value="2.5" selected>2.5x</option><option value="4">4.0x</option></select>
                </div>
                <div class="opt"><label>B. Median Blur</label>
                    <select id="blurB"><option value="1">1</option><option value="3" selected>3</option><option value="5">5</option><option value="7">7</option><option value="9">9</option></select>
                </div>
                <div class="opt"><label>B. Fixed Threshold</label>
                    <select id="senseB"><option value="10">10 (Heavy)</option><option value="25">25</option><option value="40" selected>40 (Classic)</option><option value="60">60</option><option value="80">80</option><option value="100">100 (Light)</option></select>
                </div>
            </div>

            <div class="opt"><label>Edge Boldness (k)</label>
                <select id="kSize"><option value="1">1</option><option value="3" selected>3</option><option value="5">5</option><option value="7">7</option></select>
            </div>

            <button id="bootBtn" disabled onclick="bootApp()">BOOT ENGINE</button>
            <p id="status" class="status-bar">CONNECTING...</p>
        </div>
    </div>

    <div id="fps-tag">FPS: --</div>
    <video id="webcam" autoplay playsinline></video>
    <canvas id="outputCanvas"></canvas>

    <script>
        let currentPanel = 'A';
        function switchPanel(p) {
            currentPanel = p;
            document.getElementById('panelA').classList.toggle('active', p==='A');
            document.getElementById('panelB').classList.toggle('active', p==='B');
            document.getElementById('tabA').classList.toggle('active', p==='A');
            document.getElementById('tabB').classList.toggle('active', p==='B');
        }

        const video = document.getElementById('webcam'), canvas = document.getElementById('outputCanvas');
        const ctx = canvas.getContext('2d', { alpha: false }), offCanvas = document.createElement('canvas');
        const offCtx = offCanvas.getContext('2d', { willReadFrequently: true });
        const bootBtn = document.getElementById('bootBtn'), statusEl = document.getElementById('status');
        
        let worker, isProcessing = false, currentFacingMode = "user", wakeLock = null;
        let frames = 0, lastTime = performance.now(), lastFrameTime = 0;
        let config = {};

        worker = new Worker('./worker.js');
        worker.onmessage = (e) => {
            if (e.data === "READY") { statusEl.innerText = "READY"; statusEl.style.color = "#0f0"; bootBtn.disabled = false; }
            else { ctx.putImageData(e.data, 0, 0); isProcessing = false; frames++; }
        };

        async function startCamera(mode) {
            currentFacingMode = mode;
            if (video.srcObject) video.srcObject.getTracks().forEach(track => track.stop());
            const stream = await navigator.mediaDevices.getUserMedia({ video: { width: { ideal: config.width }, facingMode: currentFacingMode } });
            video.srcObject = stream;
        }

        async function bootApp() {
            config = {
                panel: currentPanel,
                width: parseInt(document.getElementById('resSelect').value),
                scale: parseFloat(document.getElementById(currentPanel === 'A' ? 'scaleA' : 'scaleB').value),
                blur: parseInt(document.getElementById(currentPanel === 'A' ? 'blurA' : 'blurB').value),
                sense: parseFloat(document.getElementById(currentPanel === 'A' ? 'senseA' : 'senseB').value),
                k: parseInt(document.getElementById('kSize').value)
            };
            
            try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
            if (document.documentElement.requestFullscreen) await document.documentElement.requestFullscreen();
            await startCamera("user");

            video.onloadedmetadata = () => {
                canvas.width = offCanvas.width = video.videoWidth / config.scale;
                canvas.height = offCanvas.height = video.videoHeight / config.scale;
                document.getElementById('dashboard').style.display = 'none';
                canvas.style.display = 'block';
                requestAnimationFrame(loop);
            };
        }

        function loop() {
            const now = performance.now();
            if (now - lastFrameTime >= 30 && !isProcessing) {
                isProcessing = true;
                lastFrameTime = now;
                offCtx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imgData = offCtx.getImageData(0, 0, canvas.width, canvas.height);
                worker.postMessage({ img: imgData, ...config, isFront: (currentFacingMode === "user") }, [imgData.data.buffer]);
                
                if (now - lastTime >= 1000) { document.getElementById('fps-tag').innerText = `FPS: ${frames}`; frames = 0; lastTime = now; }
            }
            requestAnimationFrame(loop);
        }

        let tapCount = 0, tapTimer;
        window.addEventListener('touchstart', (e) => {
            tapCount++; clearTimeout(tapTimer);
            tapTimer = setTimeout(() => {
                if (tapCount === 2) { const tag = document.getElementById('fps-tag'); tag.style.display = (tag.style.display === 'none' ? 'block' : 'none'); }
                if (tapCount === 3) startCamera(currentFacingMode === "user" ? "environment" : "user");
                if (tapCount === 4) silentSnapshot();
                tapCount = 0;
            }, 300);
        });

        function silentSnapshot() {
            const link = document.createElement('a'); link.download = `snap_${Date.now()}.png`;
            link.href = canvas.toDataURL(); link.click();
        }
    </script>
</body>
</html>
