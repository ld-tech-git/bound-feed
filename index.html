<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>Laplacian Pro: Clean Feed</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; color: #0f0; font-family: monospace; overflow: hidden; }
        #dashboard { 
            position: fixed; inset: 0; z-index: 100; background: #000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .box { border: 1px solid #0f0; padding: 25px; border-radius: 10px; background: #0a0a0a; width: 300px; text-align: center; }
        select, button { width: 100%; padding: 12px; margin: 8px 0; background: #000; color: #0f0; border: 1px solid #0f0; font-family: monospace; font-size: 1rem; }
        #fps-tag { position: fixed; top: 15px; right: 15px; z-index: 50; font-size: 14px; background: rgba(0,0,0,0.6); padding: 8px; border-radius: 4px; display: none; pointer-events: none; border: 1px solid rgba(0,255,0,0.3); }
        #timer { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 120px; z-index: 60; display: none; color: #fff; font-weight: bold; text-shadow: 0 0 20px #0f0; }
        canvas { position: absolute; inset: 0; width: 100vw; height: 100vh; object-fit: cover; display: none; z-index: 1; }
        #webcam { display: none; }
    </style>
</head>
<body>

    <div id="dashboard">
        <div class="box">
            <h3 style="margin-top:0">SYSTEM SETUP</h3>
            <label>INPUT RESOLUTION</label>
            <select id="resSelect">
                <option value="1920">1080p (True HD)</option>
                <option value="1280" selected>720p (Balanced)</option>
                <option value="640">480p (Speed Focus)</option>
            </select>
            <label>TARGET FPS</label>
            <select id="fpsSelect">
                <option value="15">15 FPS (Stable)</option>
                <option value="24" selected>24 FPS (Cinema)</option>
                <option value="30">30 FPS (Fluid)</option>
            </select>
            <button onclick="bootApp()">BOOT FULLSCREEN</button>
        </div>
    </div>

    <div id="fps-tag">FPS: --</div>
    <div id="timer">7</div>
    <video id="webcam" autoplay playsinline></video>
    <canvas id="outputCanvas"></canvas>

    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('outputCanvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        const timerEl = document.getElementById('timer');
        const fpsTag = document.getElementById('fps-tag');
        
        let worker, targetFPS, isProcessing = false;
        let frames = 0, lastTime = performance.now(), lastFrameTime = 0;

        async function bootApp() {
            const width = parseInt(document.getElementById('resSelect').value);
            targetFPS = parseInt(document.getElementById('fpsSelect').value);
            
            if (document.documentElement.requestFullscreen) await document.documentElement.requestFullscreen();
            if (screen.orientation?.lock) await screen.orientation.lock('landscape').catch(()=>{});

            document.getElementById('dashboard').style.display = 'none';
            canvas.style.display = 'block';
            fpsTag.style.display = 'block'; // Initially show it

            worker = new Worker('worker.js');
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { width: { ideal: width }, facingMode: "user" }, audio: false 
            });
            video.srcObject = stream;

            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                requestAnimationFrame(processFrame);
            };

            worker.onmessage = (e) => {
                ctx.putImageData(e.data, 0, 0);
                isProcessing = false;
                frames++;
                const now = performance.now();
                if (now - lastTime >= 1000) {
                    fpsTag.innerText = `FPS: ${frames}`;
                    frames = 0; lastTime = now;
                }
            };
        }

        function processFrame() {
            const now = performance.now();
            const interval = 1000 / targetFPS;
            
            if (now - lastFrameTime >= interval && !isProcessing) {
                isProcessing = true;
                lastFrameTime = now;
                ctx.drawImage(video, 0, 0);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                // Zero-copy transfer of buffer to worker
                worker.postMessage(imageData, [imageData.data.buffer]);
            }
            requestAnimationFrame(processFrame);
        }

        // --- GESTURE LOGIC ---
        let tapCount = 0;
        let tapTimer;

        window.addEventListener('touchstart', (e) => {
            tapCount++;
            clearTimeout(tapTimer);
            tapTimer = setTimeout(() => {
                if (tapCount === 2) {
                    // Double Tap: Toggle FPS Visibility
                    fpsTag.style.display = fpsTag.style.display === 'none' ? 'block' : 'none';
                }
                if (tapCount === 3) {
                    // Triple Tap: Snapshot countdown
                    startSnapshot();
                }
                tapCount = 0;
            }, 350); 
        });

        function startSnapshot() {
            let count = 7;
            timerEl.style.display = 'block';
            timerEl.innerText = count;
            const countdown = setInterval(() => {
                count--;
                timerEl.innerText = count;
                if (count === 0) {
                    clearInterval(countdown);
                    timerEl.style.display = 'none';
                    saveImage();
                }
            }, 1000);
        }

        function saveImage() {
            const link = document.createElement('a');
            link.download = `capture_${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }
    </script>
</body>
</html>
