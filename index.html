<!-- prev version works for 720p, too much clarity and choppy but works for standard, this is for change for smoothness -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>Laplacian Pixel-Binning</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; color: #0f0; font-family: sans-serif; overflow: hidden; }
        #launcher { position: fixed; inset: 0; background: #0a0a0a; z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .config-box { background: #1a1a1a; padding: 30px; border: 2px solid #0f0; border-radius: 15px; width: 100%; max-width: 350px; text-align: center; }
        .option { margin-bottom: 25px; text-align: left; }
        label { font-size: 11px; color: #888; text-transform: uppercase; }
        select { width: 100%; background: #000; color: #0f0; border: 1px solid #0f0; padding: 12px; margin-top: 8px; font-size: 1rem; }
        #startBtn { width: 100%; background: #0f0; color: #000; border: none; padding: 20px; font-size: 1.2rem; font-weight: bold; border-radius: 10px; cursor: pointer; }
        #startBtn:disabled { background: #050; color: #444; }
        canvas { position: absolute; inset: 0; width: 100vw; height: 100vh; object-fit: cover; z-index: 1; display: none; image-rendering: pixelated; }
        #webcam { display: none; }
    </style>
</head>
<body>

    <div id="launcher">
        <div class="config-box">
            <h2 style="margin-top:0;">BLOCK COMPRESSION</h2>
            <div class="option">
                <label>Pixel Grouping (Chunk Size)</label>
                <select id="blockSize">
                    <option value="1">1x1 (Full Detail - Slowest)</option>
                    <option value="2" selected>2x2 (4px Chunks - Fast)</option>
                    <option value="3">3x3 (9px Chunks - Very Fast)</option>
                    <option value="4">4x4 (16px Chunks - Ultra Smooth)</option>
                </select>
            </div>
            <button id="startBtn" disabled onclick="goLive()">BOOT SENSOR</button>
            <p id="loading-msg" style="font-size: 10px; margin-top:15px; font-family: monospace;">LOADING BINNING MODULES...</p>
        </div>
    </div>

    <video id="webcam" autoplay playsinline></video>
    <canvas id="outputCanvas"></canvas>

    <script>
        window.BLOCK_SIZE = 2;

        async function goLive() {
            window.BLOCK_SIZE = parseInt(document.getElementById('blockSize').value);
            
            const doc = document.documentElement;
            if (doc.requestFullscreen) await doc.requestFullscreen();
            
            if (screen.orientation && screen.orientation.lock) {
                await screen.orientation.lock('landscape').catch(() => {});
            }

            document.getElementById('launcher').style.display = 'none';
            document.getElementById('outputCanvas').style.display = 'block';

            const video = document.getElementById('webcam');
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { width: 1280, height: 720, facingMode: "user" }, 
                audio: false 
            });
            video.srcObject = stream;
        }

        function pythonReady() {
            document.getElementById('loading-msg').innerText = "ENGINE READY";
            document.getElementById('startBtn').disabled = false;
        }
    </script>

    <script type="py" config='{"packages": ["opencv-python", "numpy"]}'>
        import cv2
        import numpy as np
        from js import document, window, requestAnimationFrame, pythonReady
        from pyodide.ffi import create_proxy

        pythonReady()
        video = document.getElementById("webcam")
        canvas = document.getElementById("outputCanvas")
        ctx = canvas.getContext("2d")

        def loop(t):
            if video.videoWidth > 0:
                # 1. Determine "Binned" Dimensions
                chunk = window.BLOCK_SIZE
                proc_w = int(video.videoWidth / chunk)
                proc_h = int(video.videoHeight / chunk)
                
                if canvas.width != proc_w:
                    canvas.width = proc_w
                    canvas.height = proc_h
                
                # 2. Extract and Bin (Downsample via drawImage)
                ctx.drawImage(video, 0, 0, proc_w, proc_h)
                img_data = ctx.getImageData(0, 0, proc_w, proc_h)
                
                frame = np.frombuffer(img_data.data.to_py(), dtype=np.uint8).reshape((proc_h, proc_w, 4))
                frame = cv2.flip(frame, 1)

                # 3. Process the "Chunked" Frame
                bgr = cv2.cvtColor(frame, cv2.COLOR_RGBA2BGR)
                gray = cv2.cvtColor(bgr, cv2.COLOR_BGR2GRAY)
                
                # Since we are chunking, we reduce blur kernel to compensate
                blurred = cv2.medianBlur(gray, 3) 
                edges = cv2.Laplacian(blurred, cv2.CV_8U, ksize=3)
                
                _, thresh = cv2.threshold(edges, 0, 255, cv2.THRESH_BINARY + cv2.THRESH_OTSU)
                
                # Apply color mask
                mask = cv2.bitwise_and(bgr, bgr, mask=thresh)

                # 4. Output to Canvas (Browser will scale it back up to 1080p)
                res_rgba = cv2.cvtColor(mask, cv2.COLOR_BGR2RGBA)
                img_ptr = window.ImageData.new(window.Uint8ClampedArray.new(res_rgba.tobytes()), proc_w, proc_h)
                ctx.putImageData(img_ptr, 0, 0)

            requestAnimationFrame(create_proxy(loop))

        loop(0)
    </script>
</body>
</html>
