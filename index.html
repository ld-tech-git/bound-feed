<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>Laplacian Pro | Bound-Feed Master</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; color: #0f0; font-family: monospace; overflow: hidden; }
        #dashboard { position: fixed; inset: 0; z-index: 100; background: #0a0a0a; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow-y: auto; padding: 20px; }
        .box { border: 1px solid #0f0; padding: 25px; background: #1a1a1a; width: 340px; text-align: center; border-radius: 15px; box-shadow: 0 0 20px rgba(0,255,0,0.2); }
        .opt { margin-bottom: 12px; text-align: left; }
        label { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 4px; }
        select, button { width: 100%; padding: 10px; background: #000; color: #0f0; border: 1px solid #0f0; font-family: monospace; border-radius: 5px; cursor: pointer; }
        #fps-tag { position: fixed; top: 15px; right: 15px; z-index: 50; font-size: 14px; background: rgba(0,0,0,0.6); padding: 8px; display: none; border: 1px solid #0f0; pointer-events: none; }
        #timer { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 120px; z-index: 60; display: none; color: #fff; font-weight: bold; }
        #outputCanvas { position: absolute; inset: 0; width: 100vw; height: 100vh; object-fit: cover; display: none; z-index: 1; }
        #webcam { display: none; }
        .status-bar { font-size: 10px; margin-top: 15px; color: #f00; }
    </style>
</head>
<body>

    <div id="dashboard">
        <div class="box">
            <h2 style="margin:0 0 15px 0; font-size: 1.2rem;">SYSTEM CONFIG</h2>
            
            <div class="opt">
                <label>1. Input Resolution</label>
                <select id="resSelect">
                    <option value="1920">1080p</option>
                    <option value="1280" selected>720p</option>
                    <option value="640">480p</option>
                </select>
            </div>

            <div class="opt">
                <label>2. Processing Scale</label>
                <select id="chunkSelect">
                    <option value="1">Quality</option>
                    <option value="1.5" selected>Balanced</option>
                    <option value="2.5">Turbo</option>
                </select>
            </div>

            <div class="opt">
                <label>3. Skin Detail (Noise Filter)</label>
                <select id="blurSelect">
                    <option value="3">High (Sharp)</option>
                    <option value="5" selected>Standard</option>
                    <option value="7">Clean Face</option>
                    <option value="11">Maximum Smooth</option>
                </select>
            </div>

            <div class="opt">
                <label>4. Detection Sensitivity</label>
                <select id="senseSelect">
                    <option value="0.7">Maximum (Dark Rooms)</option>
                    <option value="0.9" selected>Standard</option>
                    <option value="1.3">Strict (Clear Lighting)</option>
                </select>
            </div>

            <div class="opt">
                <label>5. Edge Thickness (k-Size)</label>
                <select id="kSizeSelect">
                    <option value="1">Thin</option>
                    <option value="3">Medium</option>
                    <option value="5" selected>Bold</option>
                    <option value="7">Ultra</option>
                </select>
            </div>

            <div class="opt">
                <label>6. Line Expansion</label>
                <select id="dilateSelect">
                    <option value="0" selected>None</option>
                    <option value="1">1px (Bold)</option>
                    <option value="2">2px (Maximum)</option>
                </select>
            </div>

            <button id="bootBtn" disabled onclick="bootApp()">BOOT SYSTEM</button>
            <p id="status" class="status-bar">CONNECTING TO WORKER...</p>
        </div>
    </div>

    <div id="fps-tag">FPS: --</div>
    <div id="timer">7</div>
    <video id="webcam" autoplay playsinline></video>
    <canvas id="outputCanvas"></canvas>

    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('outputCanvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        const offCanvas = document.createElement('canvas');
        const offCtx = offCanvas.getContext('2d', { willReadFrequently: true });
        const bootBtn = document.getElementById('bootBtn');
        const statusEl = document.getElementById('status');
        
        let worker, targetFPS = 24, chunkScale, blurSize, kSize, dilate, sensitivity, isProcessing = false;
        let frames = 0, lastTime = performance.now(), lastFrameTime = 0;

        // Path Correction for GitHub Pages subfolders
        worker = new Worker('./worker.js');
        
        worker.onmessage = (e) => {
            if (e.data === "READY") {
                statusEl.innerText = "CORE ENGINE READY";
                statusEl.style.color = "#0f0";
                bootBtn.disabled = false;
            } else {
                ctx.putImageData(e.data, 0, 0);
                isProcessing = false;
                frames++;
            }
        };

        worker.onerror = (err) => {
            statusEl.innerText = "PATH ERROR: worker.js not found in current folder.";
            console.error(err);
        };

        async function bootApp() {
            chunkScale = parseFloat(document.getElementById('chunkSelect').value);
            blurSize = parseInt(document.getElementById('blurSelect').value);
            kSize = parseInt(document.getElementById('kSizeSelect').value);
            dilate = parseInt(document.getElementById('dilateSelect').value);
            sensitivity = parseFloat(document.getElementById('senseSelect').value);
            const width = parseInt(document.getElementById('resSelect').value);
            
            if (document.documentElement.requestFullscreen) await document.documentElement.requestFullscreen();
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: { ideal: width }, facingMode: "user" }
                });
                video.srcObject = stream;
            } catch (err) { alert("Camera Denied"); return; }

            video.onloadedmetadata = () => {
                const w = video.videoWidth / chunkScale;
                const h = video.videoHeight / chunkScale;
                canvas.width = offCanvas.width = w;
                canvas.height = offCanvas.height = h;
                document.getElementById('dashboard').style.display = 'none';
                canvas.style.display = 'block';
                document.getElementById('fps-tag').style.display = 'block';
                processFrame();
            };
        }

        function processFrame() {
            const now = performance.now();
            if (now - lastFrameTime >= (1000 / targetFPS) && !isProcessing) {
                isProcessing = true;
                lastFrameTime = now;
                offCtx.drawImage(video, 0, 0, offCanvas.width, offCanvas.height);
                const imageData = offCtx.getImageData(0, 0, offCanvas.width, offCanvas.height);
                
                worker.postMessage({
                    img: imageData, 
                    blur: blurSize,
                    kSize: kSize,
                    dilate: dilate,
                    sense: sensitivity
                }, [imageData.data.buffer]);
                
                if (now - lastTime >= 1000) {
                    document.getElementById('fps-tag').innerText = `FPS: ${frames}`;
                    frames = 0; lastTime = now;
                }
            }
            requestAnimationFrame(processFrame);
        }

        // Snapshot Logic (Triple Tap)
        window.addEventListener('touchstart', (e) => {
            if (e.touches.length === 3) startSnapshot();
        });

        function startSnapshot() {
            let count = 7;
            const timerEl = document.getElementById('timer');
            timerEl.style.display = 'block';
            timerEl.innerText = count;
            const countdown = setInterval(() => {
                timerEl.innerText = --count;
                if (count === 0) {
                    clearInterval(countdown);
                    timerEl.style.display = 'none';
                    const link = document.createElement('a');
                    link.download = `capture_${Date.now()}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                }
            }, 1000);
        }
    </script>
</body>
</html>
