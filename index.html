<script>
    let currentPanel = 'A', isLibReady = false, isRecording = false;
    const video = document.getElementById('webcam'), canvas = document.getElementById('outputCanvas');
    const ctx = canvas.getContext('2d', { alpha: false }), offCanvas = document.createElement('canvas');
    const offCtx = offCanvas.getContext('2d', { willReadFrequently: true });
    let worker, isProcessing = false, currentFacingMode = "user", activeConfig = null;
    let mediaRecorder, recordedChunks = [], frames = 0, lastTime = performance.now();

    worker = new Worker('./worker.js');
    worker.onmessage = (e) => {
        if (e.data === "READY") {
            isLibReady = true;
            const b = document.getElementById('bootBtn');
            b.innerText = "BOOT ENGINE"; b.classList.add('ready');
            document.getElementById('status').innerText = "ONLINE"; document.getElementById('status').style.color = "#0f0";
        } else if (e.data === "RECOVER") {
            // STABILITY FIX: Unlock loop if worker crashed
            isProcessing = false;
        } else { 
            ctx.putImageData(e.data, 0, 0); 
            isProcessing = false; 
            frames++; 
        }
    };

    function switchPanel(p) {
        currentPanel = p;
        document.getElementById('panelA').classList.toggle('active', p==='A');
        document.getElementById('panelB').classList.toggle('active', p==='B');
        document.getElementById('tabA').classList.toggle('active', p==='A');
        document.getElementById('tabB').classList.toggle('active', p==='B');
    }

    async function bootApp() {
        if(!isLibReady) return;
        activeConfig = {
            panel: currentPanel,
            scale: parseFloat(document.getElementById(currentPanel === 'A' ? 'scaleA' : 'scaleB').value),
            blur: parseInt(document.getElementById(currentPanel === 'A' ? 'blurA' : 'blurB').value),
            sense: parseFloat(document.getElementById(currentPanel === 'A' ? 'senseA' : 'senseB').value),
            k: parseInt(document.getElementById('kSize').value),
            oldCode: (currentPanel === 'B' && document.getElementById('logicB').value === 'old_code')
        };
        const stream = await navigator.mediaDevices.getUserMedia({ video: { width: { ideal: parseInt(document.getElementById('res').value) }, facingMode: currentFacingMode } });
        video.srcObject = stream;
        video.onloadedmetadata = () => {
            canvas.width = offCanvas.width = Math.floor(video.videoWidth / activeConfig.scale);
            canvas.height = offCanvas.height = Math.floor(video.videoHeight / activeConfig.scale);
            document.getElementById('dashboard').style.display = 'none';
            canvas.style.display = 'block';
            document.getElementById('fsToggle').className = 'pos-normal';
            document.getElementById('fsToggle').style.display = 'block';
            requestAnimationFrame(processLoop);
        };
    }

    function toggleFullScreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
        } else {
            if (document.exitFullscreen) document.exitFullscreen();
        }
    }

    document.addEventListener('fullscreenchange', () => {
        const btn = document.getElementById('fsToggle');
        if (document.fullscreenElement) {
            btn.style.display = 'none'; 
            btn.classList.add('exit');
            btn.classList.replace('pos-normal', 'pos-fs');
        } else {
            btn.style.display = 'block';
            btn.classList.remove('exit');
            btn.classList.replace('pos-fs', 'pos-normal');
        }
    });

    async function toggleRecording() {
        if (!isRecording) {
            recordedChunks = [];
            const stream = canvas.captureStream(30);
            if (document.getElementById('micEnable').value === 'yes') {
                const audio = await navigator.mediaDevices.getUserMedia({ audio: true });
                audio.getAudioTracks().forEach(t => stream.addTrack(t));
            }
            const mime = document.getElementById('recFormat').value;
            mediaRecorder = new MediaRecorder(stream, { mimeType: MediaRecorder.isTypeSupported(mime) ? mime : 'video/webm' });
            mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
            mediaRecorder.onstop = () => {
                const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob(recordedChunks));
                a.download = `laplacian_${Date.now()}.webm`; a.click();
            };
            mediaRecorder.start(); isRecording = true; document.getElementById('rec-indicator').style.display = 'block';
        } else { mediaRecorder.stop(); isRecording = false; document.getElementById('rec-indicator').style.display = 'none'; }
    }

    function processLoop() {
        if (!isProcessing && video.videoWidth > 0 && activeConfig) {
            isProcessing = true;
            offCtx.drawImage(video, 0, 0, offCanvas.width, offCanvas.height);
            const imgData = offCtx.getImageData(0, 0, offCanvas.width, offCanvas.height);
            // Pass configuration and image to worker
            worker.postMessage({ img: imgData, ...activeConfig, isFront: (currentFacingMode === "user") }, [imgData.data.buffer]);
        }
        if (performance.now() - lastTime >= 1000) { document.getElementById('fps-tag').innerText = `FPS: ${frames}`; frames = 0; lastTime = performance.now(); }
        requestAnimationFrame(processLoop);
    }

    window.addEventListener('contextmenu', e => { e.preventDefault(); toggleRecording(); });
    let touchX = 0;
    window.addEventListener('touchstart', e => { touchX = e.changedTouches[0].screenX; });
    window.addEventListener('touchend', e => { if (touchX - e.changedTouches[0].screenX > 100) toggleRecording(); });

    let taps = 0, tapT, fsTimer;
    window.addEventListener('touchstart', () => {
        taps++; clearTimeout(tapT);
        
        const btn = document.getElementById('fsToggle');
        btn.style.display = 'block';
        clearTimeout(fsTimer);
        fsTimer = setTimeout(() => { if(document.fullscreenElement) btn.style.display = 'none'; }, 3000);

        tapT = setTimeout(() => {
            if (taps === 2) { const f = document.getElementById('fps-tag'); f.style.display = f.style.display === 'none' ? 'block' : 'none'; }
            if (taps === 3) { currentFacingMode = currentFacingMode === "user" ? "environment" : "user"; bootApp(); }
            if (taps === 4) setTimeout(() => {
                const l = document.createElement('a'); l.download = `snap_${Date.now()}.png`; l.href = canvas.toDataURL(); l.click();
            }, 7000); // 7s delay as requested
            taps = 0;
        }, 300);
    });
</script>
