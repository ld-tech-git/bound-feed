<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>Laplacian Pro | Absolute Master v5</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; color: #0f0; font-family: monospace; overflow: hidden; touch-action: none; }
        #dashboard { position: fixed; inset: 0; z-index: 100; background: #0a0a0a; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; }
        .box { border: 1px solid #0f0; padding: 20px; background: #1a1a1a; width: 360px; border-radius: 15px; text-align: center; box-shadow: 0 0 20px rgba(0,255,0,0.3); }
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .tab { flex: 1; padding: 12px; border: 1px solid #0f0; cursor: pointer; font-size: 11px; opacity: 0.4; transition: 0.3s; }
        .tab.active { opacity: 1; background: #0f0; color: #000; font-weight: bold; }
        .panel { display: none; border-top: 1px solid #333; padding-top: 10px; }
        .panel.active { display: block; }
        .opt { margin-bottom: 12px; text-align: left; }
        label { font-size: 10px; color: #888; display: block; margin-bottom: 4px; text-transform: uppercase; }
        select, button { width: 100%; padding: 12px; background: #000; color: #0f0; border: 1px solid #0f0; font-family: monospace; border-radius: 5px; font-size: 13px; }
        #bootBtn { background: #222; color: #444; cursor: not-allowed; margin-top: 10px; transition: 0.3s; }
        #bootBtn.ready { background: #0f0; color: #000; cursor: pointer; font-weight: bold; }
        #fps-tag { position: fixed; top: 15px; left: 15px; z-index: 60; color: #0f0; display: none; background: rgba(0,0,0,0.6); padding: 8px; border: 1px solid #0f0; pointer-events: none; }
        #rec-indicator { position: fixed; top: 15px; right: 15px; z-index: 55; color: #f00; display: none; font-weight: bold; animation: blink 1s infinite; }
        #fsToggle { position: fixed; z-index: 80; width: 44px; height: 44px; border: 2px solid #555; display: none; cursor: pointer; background: rgba(50,50,50,0.5); border-radius: 5px; }
        #fsToggle::after { content: ""; position: absolute; inset: 10px; border: 3px solid #888; border-style: solid none none solid; }
        #fsToggle.exit::after { border-style: none solid solid none; }
        .pos-normal { bottom: 30px; right: 30px; }
        .pos-fs { bottom: 30px; left: 30px; }
        @keyframes blink { 50% { opacity: 0; } }
        canvas { position: absolute; inset: 0; width: 100vw; height: 100vh; object-fit: cover; display: none; z-index: 1; }
        #webcam { display: none; }
        .status { font-size: 10px; margin-top: 10px; color: #f00; font-weight: bold; }
        .rec-box { border: 1px dashed #f00; padding: 10px; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div id="fps-tag">FPS: --</div>
    <div id="rec-indicator">‚óè REC</div>
    <div id="fsToggle" onclick="toggleFullScreen()"></div>

    <div id="dashboard">
        <div class="box">
            <h2 style="margin:0 0 10px 0; letter-spacing: 1px;">SYSTEM CONFIG</h2>
            <div class="rec-box">
                <label style="color: #f00;">Global Recording</label>
                <div class="opt">
                    <label>Format</label>
                    <select id="recFormat">
                        <option value="video/webm;codecs=vp9">WEBM (Universal)</option>
                        <option value="video/mp4">MP4 (PC Only)</option>
                    </select>
                </div>
                <div class="opt">
                    <label>Microphone</label>
                    <select id="micEnable">
                        <option value="no" selected>No Audio</option>
                        <option value="yes">With Audio</option>
                    </select>
                </div>
            </div>

            <div class="tabs">
                <div id="tabA" class="tab active" onclick="switchPanel('A')">PANEL A<br>(GAU_OTS)</div>
                <div id="tabB" class="tab" onclick="switchPanel('B')">PANEL B<br>(MEDIAN)</div>
            </div>

            <div class="opt">
                <label>Resolution</label>
                <select id="res">
                    <option value="1920">1080p (True HD)</option>
                    <option value="1600">900p (High)</option>
                    <option value="1280" selected>720p (Balanced)</option>
                    <option value="1024">1024px</option>
                    <option value="800">800px</option>
                    <option value="640">480p (Fast)</option>
                    <option value="480">360p (Turbo)</option>
                </select>
            </div>

            <!-- Panel A and B settings (unchanged) -->
            <div id="panelA" class="panel active">
                <div class="opt"><label>A. Scale</label>
                    <select id="scaleA">
                        <option value="1">1.0x</option><option value="1.2">1.2x</option>
                        <option value="1.5" selected>1.5x</option><option value="2">2.0x</option>
                        <option value="2.5">2.5x</option><option value="3.0">3.0x</option>
                    </select>
                </div>
                <div class="opt"><label>A. Gaussian Blur</label>
                    <select id="blurA">
                        <option value="1">None</option><option value="3">3px</option>
                        <option value="5" selected>5px</option><option value="7">7px</option>
                        <option value="9">9px</option><option value="11">11px</option><option value="15">15px</option>
                    </select>
                </div>
                <div class="opt"><label>A. Sensitivity</label>
                    <select id="senseA">
                        <option value="0.5">0.5 (Max)</option><option value="0.7">0.7</option>
                        <option value="0.9" selected>0.9 (Std)</option><option value="1.1">1.1</option>
                        <option value="1.3">1.3</option><option value="1.5">1.5</option>
                    </select>
                </div>
            </div>

            <div id="panelB" class="panel">
                <div class="opt"><label>B. Logic</label>
                    <select id="logicB">
                        <option value="old_code" selected>old_code_use (Python)</option>
                        <option value="median">Standard Median</option>
                    </select>
                </div>
                <div class="opt"><label>B. Scale</label>
                    <select id="scaleB">
                        <option value="1">1.0x</option><option value="1.5">1.5x</option>
                        <option value="2.5" selected>2.5x</option><option value="3.5">3.5x</option>
                        <option value="5">5.0x</option>
                    </select>
                </div>
                <div class="opt"><label>B. Median Blur</label>
                    <select id="blurB">
                        <option value="1">1</option><option value="3" selected>3</option>
                        <option value="5">5</option><option value="7">7</option>
                        <option value="9">9</option>
                    </select>
                </div>
                <div class="opt"><label>B. Fixed Threshold</label>
                    <select id="senseB">
                        <option value="10">10</option><option value="20">20</option>
                        <option value="40" selected>40</option><option value="60">60</option>
                        <option value="80">80</option><option value="100">100</option>
                    </select>
                </div>
            </div>

            <div class="opt"><label>Edge Thickness (k)</label>
                <select id="kSize">
                    <option value="1">1 (Fine)</option><option value="3" selected>3 (Std)</option>
                    <option value="5">5 (Bold)</option><option value="7">7 (Heavy)</option>
                </select>
            </div>

            <button id="bootBtn" onclick="bootApp()">WAITING FOR LIB...</button>
            <div id="status" class="status">LOADING OPENCV...</div>
        </div>
    </div>

    <video id="webcam" autoplay playsinline></video>
    <canvas id="outputCanvas"></canvas>

    <script>
        /* ================= DOM ================= */
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('outputCanvas');
        const ctx = canvas.getContext('2d', {alpha:false});
        const offCanvas = document.createElement('canvas');
        const offCtx = offCanvas.getContext('2d');
        const bootBtn = document.getElementById('bootBtn');
        const status = document.getElementById('status');
        const dashboard = document.getElementById('dashboard');
        const fpsTag = document.getElementById('fps-tag');
        const fsToggle = document.getElementById('fsToggle');
        const logicB = document.getElementById('logicB');
        const res = document.getElementById('res');

        /* ================= STATE ================= */
        let worker = null;
        let isLibReady = false;
        let isProcessing = false;
        let frameQueue = [];
        let currentPanel = 'A';
        let currentFacingMode = 'user';
        let activeConfig = null;
        let frames = 0;
        let lastTime = performance.now();
        let lastWorkerResponse = performance.now();
        let lastVideoTime = -1;
        let healthInterval = null;
        let fsTimer;

        /* ================= WORKER ================= */
        function initWorker(){
            if(worker) worker.terminate();
            worker = new Worker('./worker.js');
            worker.onmessage = (e)=>{
                if(e.data==="READY"){
                    isLibReady=true;
                    bootBtn.innerText="BOOT ENGINE";
                    bootBtn.classList.add('ready');
                    status.innerText="ONLINE";
                    status.style.color="#0f0";
                } else if(e.data==="PONG"){
                    lastWorkerResponse = performance.now();
                } else if(e.data==="RECOVER"){
                    isProcessing=false;
                } else {
                    ctx.putImageData(e.data,0,0);
                    frames++;
                    isProcessing=false;
                    lastWorkerResponse = performance.now();
                }
            };
        }

        window.onload = ()=>{ initWorker(); };

        function switchPanel(p){
            currentPanel=p;
            document.getElementById('panelA').classList.toggle('active', p==='A');
            document.getElementById('panelB').classList.toggle('active', p==='B');
            document.getElementById('tabA').classList.toggle('active', p==='A');
            document.getElementById('tabB').classList.toggle('active', p==='B');
        }

        function toggleRecording(){ /* stub to prevent errors */ }

        /* ================= BOOT ================= */
        async function bootApp(){
            if(!isLibReady) return;
            isProcessing=false;
            if(video.srcObject) video.srcObject.getTracks().forEach(t=>t.stop());

            activeConfig = {
                panel: currentPanel,
                scale: parseFloat(document.getElementById(currentPanel==='A'?'scaleA':'scaleB').value),
                blur: parseInt(document.getElementById(currentPanel==='A'?'blurA':'blurB').value),
                sense: parseFloat(document.getElementById(currentPanel==='A'?'senseA':'senseB').value),
                k: parseInt(document.getElementById('kSize').value),
                oldCode: currentPanel==='B' && logicB.value==='old_code'
            };

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video:{ width:{ideal:parseInt(res.value)}, facingMode:currentFacingMode }
                });
                video.srcObject = stream;
                video.onloadedmetadata=()=>{
                    canvas.width = offCanvas.width = Math.floor(video.videoWidth / activeConfig.scale);
                    canvas.height = offCanvas.height = Math.floor(video.videoHeight / activeConfig.scale);
                    dashboard.style.display='none';
                    canvas.style.display='block';
                    fsToggle.style.display='block';
                    fsToggle.className='pos-normal';
                    if(!healthInterval) startHealthCheck();
                    requestAnimationFrame(processLoop);
                };
            } catch(err){
                status.innerText="CAMERA ERROR";
            }
        }

        /* ================= HEALTH CHECK ================= */
        function startHealthCheck(){
            healthInterval = setInterval(()=>{
                if(!activeConfig || dashboard.style.display!=='none') return;
                const now = performance.now();
                const isVideoStalled = (video.currentTime===lastVideoTime);
                lastVideoTime = video.currentTime;

                if(now-lastWorkerResponse>3000 || isVideoStalled) isProcessing=false, worker.postMessage("PING");
                if(now-lastWorkerResponse>7000) initWorker(), bootApp();
            },2000);
        }

        /* ================= MAIN LOOP ================= */
        function processLoop(){
            if(!isProcessing && video.videoWidth>0 && activeConfig){
                isProcessing=true;
                offCtx.drawImage(video,0,0,offCanvas.width,offCanvas.height);
                const imgData = offCtx.getImageData(0,0,offCanvas.width,offCanvas.height);
                worker.postMessage({...activeConfig, img:imgData, isFront:(currentFacingMode==='user')}, [imgData.data.buffer]);
            }
            const now = performance.now();
            if(now-lastTime>=1000){ fpsTag.innerText=`FPS: ${frames}`; frames=0; lastTime=now; }
            requestAnimationFrame(processLoop);
        }

        /* ================= FULLSCREEN ================= */
        function toggleFullScreen(){
            if(!document.fullscreenElement) document.documentElement.requestFullscreen();
            else if(document.exitFullscreen) document.exitFullscreen();
        }

        document.addEventListener('fullscreenchange',()=>{
            if(document.fullscreenElement){
                fsToggle.classList.add('exit');
                fsToggle.classList.replace('pos-normal','pos-fs');
                clearTimeout(fsTimer);
                fsTimer=setTimeout(()=>fsToggle.style.display='none',3000);
            } else {
                fsToggle.classList.remove('exit');
                fsToggle.classList.replace('pos-fs','pos-normal');
                fsToggle.style.display='block';
            }
        });
    </script>
</body>
</html>
