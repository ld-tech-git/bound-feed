<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>Laplacian Pro | Recording Master</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; color: #0f0; font-family: monospace; overflow: hidden; touch-action: none; }
        #dashboard { position: fixed; inset: 0; z-index: 100; background: #0a0a0a; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; }
        .box { border: 1px solid #0f0; padding: 20px; background: #1a1a1a; width: 340px; border-radius: 15px; text-align: center; }
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .tab { flex: 1; padding: 12px; border: 1px solid #0f0; cursor: pointer; font-size: 11px; opacity: 0.4; }
        .tab.active { opacity: 1; background: #0f0; color: #000; font-weight: bold; }
        .panel { display: none; border-top: 1px solid #333; padding-top: 10px; }
        .panel.active { display: block; }
        .opt { margin-bottom: 12px; text-align: left; }
        label { font-size: 10px; color: #888; display: block; margin-bottom: 4px; text-transform: uppercase; }
        select, button { width: 100%; padding: 12px; background: #000; color: #0f0; border: 1px solid #0f0; font-family: monospace; border-radius: 5px; }
        #bootBtn { background: #0f0; color: #000; font-weight: bold; margin-top: 10px; cursor: pointer; }
        #rec-indicator { position: fixed; top: 15px; right: 15px; z-index: 55; color: #f00; display: none; font-weight: bold; font-size: 14px; text-shadow: 0 0 5px #000; }
        canvas { position: absolute; inset: 0; width: 100vw; height: 100vh; object-fit: cover; display: none; z-index: 1; }
        #webcam { display: none; }
        .rec-box { border: 1px dashed #f00; padding: 10px; margin-bottom: 15px; }
    </style>
</head>
<body>

    <div id="dashboard">
        <div class="box">
            <h2 style="margin:0 0 10px 0;">SYSTEM CONFIG</h2>
            
            <div class="rec-box">
                <label style="color: #f00;">Global Recording Settings</label>
                <div class="opt">
                    <label>Video Format</label>
                    <select id="recFormat">
                        <option value="video/webm;codecs=vp9">WEBM (Recommended)</option>
                        <option value="video/mp4">MP4 (Desktop Only)</option>
                    </select>
                </div>
                <div class="opt">
                    <label>Microphone</label>
                    <select id="micEnable">
                        <option value="no" selected>No Audio</option>
                        <option value="yes">With Audio</option>
                    </select>
                </div>
            </div>

            <div class="tabs">
                <div id="tabA" class="tab active" onclick="switchPanel('A')">PANEL A</div>
                <div id="tabB" class="tab" onclick="switchPanel('B')">PANEL B</div>
            </div>

            <div class="opt">
                <label>Resolution</label>
                <select id="res">
                    <option value="1280" selected>720p</option>
                    <option value="1920">1080p</option>
                    <option value="640">480p</option>
                </select>
            </div>

            <div id="panelA" class="panel active">
                <div class="opt"><label>A. Scale</label><select id="scaleA"><option value="1.5" selected>1.5x</option></select></div>
                <div class="opt"><label>A. Blur</label><select id="blurA"><option value="5" selected>5px</option></select></div>
                <div class="opt"><label>A. Sense</label><select id="senseA"><option value="0.9" selected>0.9</option></select></div>
            </div>

            <div id="panelB" class="panel">
                <div class="opt"><label>B. Logic</label><select id="logicB"><option value="old_code" selected>old_code_use</option><option value="median">Median</option></select></div>
                <div class="opt"><label>B. Scale</label><select id="scaleB"><option value="2.5" selected>2.5x</option></select></div>
            </div>

            <button id="bootBtn" onclick="bootApp()">BOOT SYSTEM</button>
            <p style="font-size: 9px; color: #555;">SWIPE LEFT TO RECORD | 4-TAP SNAPSHOT</p>
        </div>
    </div>

    <div id="rec-indicator">REC ‚óè</div>
    <video id="webcam" autoplay playsinline></video>
    <canvas id="outputCanvas"></canvas>

    <script>
        let currentPanel = 'A', isLibReady = false, isRecording = false;
        const video = document.getElementById('webcam'), canvas = document.getElementById('outputCanvas');
        const ctx = canvas.getContext('2d', { alpha: false }), offCanvas = document.createElement('canvas');
        const offCtx = offCanvas.getContext('2d', { willReadFrequently: true });
        let worker, isProcessing = false, currentFacingMode = "user", activeConfig = null;
        let mediaRecorder, recordedChunks = [];

        worker = new Worker('./worker.js');
        worker.onmessage = (e) => { if (e.data === "READY") isLibReady = true; else { ctx.putImageData(e.data, 0, 0); isProcessing = false; } };

        function switchPanel(p) {
            currentPanel = p;
            document.getElementById('panelA').classList.toggle('active', p==='A');
            document.getElementById('panelB').classList.toggle('active', p==='B');
            document.getElementById('tabA').classList.toggle('active', p==='A');
            document.getElementById('tabB').classList.toggle('active', p==='B');
        }

        async function bootApp() {
            activeConfig = {
                panel: currentPanel,
                scale: parseFloat(document.getElementById(currentPanel === 'A' ? 'scaleA' : 'scaleB').value),
                blur: parseInt(document.getElementById('blurA').value),
                sense: parseFloat(document.getElementById('senseA').value),
                oldCode: (currentPanel === 'B' && document.getElementById('logicB').value === 'old_code')
            };
            if ('wakeLock' in navigator) await navigator.wakeLock.request('screen');
            const stream = await navigator.mediaDevices.getUserMedia({ video: { width: { ideal: parseInt(document.getElementById('res').value) }, facingMode: currentFacingMode } });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                canvas.width = offCanvas.width = video.videoWidth / activeConfig.scale;
                canvas.height = offCanvas.height = video.videoHeight / activeConfig.scale;
                document.getElementById('dashboard').style.display = 'none';
                canvas.style.display = 'block';
                requestAnimationFrame(processLoop);
            };
        }

        async function toggleRecording() {
            if (!isRecording) {
                recordedChunks = [];
                const stream = canvas.captureStream(30);
                if (document.getElementById('micEnable').value === 'yes') {
                    const audio = await navigator.mediaDevices.getUserMedia({ audio: true });
                    audio.getAudioTracks().forEach(t => stream.addTrack(t));
                }
                const mime = document.getElementById('recFormat').value;
                mediaRecorder = new MediaRecorder(stream, { mimeType: MediaRecorder.isTypeSupported(mime) ? mime : 'video/webm' });
                mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `laplacian_recording_${Date.now()}.webm`;
                    link.click();
                };
                mediaRecorder.start();
                isRecording = true;
                document.getElementById('rec-indicator').style.display = 'block';
            } else {
                mediaRecorder.stop();
                isRecording = false;
                document.getElementById('rec-indicator').style.display = 'none';
            }
        }

        function processLoop() {
            if (!isProcessing && video.videoWidth > 0) {
                isProcessing = true;
                offCtx.drawImage(video, 0, 0, offCanvas.width, offCanvas.height);
                const imgData = offCtx.getImageData(0, 0, offCanvas.width, offCanvas.height);
                worker.postMessage({ img: imgData, ...activeConfig, isFront: (currentFacingMode === "user") }, [imgData.data.buffer]);
            }
            requestAnimationFrame(processLoop);
        }

        // DESKTOP: Two-Finger Click (Right Click)
        window.addEventListener('contextmenu', (e) => { e.preventDefault(); toggleRecording(); });

        // MOBILE: Right-to-Left Swipe
        let touchStartX = 0;
        window.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; });
        window.addEventListener('touchend', e => {
            let touchEndX = e.changedTouches[0].screenX;
            if (touchStartX - touchEndX > 100) toggleRecording(); // Swipe Left
        });

        // SNAPSHOT: 4 Taps
        let taps = 0, tapTime;
        window.addEventListener('touchstart', () => {
            taps++; clearTimeout(tapTime);
            tapTime = setTimeout(() => {
                if (taps === 4) setTimeout(() => {
                    const link = document.createElement('a');
                    link.download = 'snap.png'; link.href = canvas.toDataURL(); link.click();
                }, 7000);
                taps = 0;
            }, 300);
        });
    </script>
</body>
</html>
