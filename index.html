<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>Laplacian Pro | Dual Cam</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; color: #0f0; font-family: monospace; overflow: hidden; }
        #dashboard { position: fixed; inset: 0; z-index: 100; background: #0a0a0a; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow-y: auto; padding: 20px; }
        .box { border: 1px solid #0f0; padding: 25px; background: #1a1a1a; width: 340px; text-align: center; border-radius: 15px; }
        .opt { margin-bottom: 15px; text-align: left; position: relative; }
        label { font-size: 10px; color: #888; text-transform: uppercase; display: block; margin-bottom: 4px; }
        .val-display { position: absolute; right: 0; top: 0; font-size: 10px; color: #0f0; background: #000; padding: 0 4px; border: 1px solid #0f0; border-radius: 3px; }
        select, button { width: 100%; padding: 10px; background: #000; color: #0f0; border: 1px solid #0f0; font-family: monospace; border-radius: 5px; cursor: pointer; }
        #fps-tag { position: fixed; top: 15px; right: 15px; z-index: 50; font-size: 14px; background: rgba(0,0,0,0.6); padding: 8px; border: 1px solid #0f0; display: none; pointer-events: none;}
        #timer { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 120px; z-index: 60; display: none; color: #fff; font-weight: bold; text-shadow: 0 0 20px #0f0; pointer-events: none;}
        #outputCanvas { position: absolute; inset: 0; width: 100vw; height: 100vh; object-fit: cover; display: none; z-index: 1; }
        #webcam { display: none; }
        .status-bar { font-size: 10px; margin-top: 15px; color: #f00; }
    </style>
</head>
<body>

    <div id="dashboard">
        <div class="box">
            <h2 style="margin:0 0 15px 0;">SYSTEM CONFIG</h2>
            
            <div class="opt">
                <label>0. Initial Camera</label>
                <select id="camSelect">
                    <option value="user" selected>Front (Selfie)</option>
                    <option value="environment">Back (World)</option>
                </select>
            </div>

            <div class="opt">
                <label>1. Resolution</label>
                <span id="resVal" class="val-display">1280px</span>
                <select id="resSelect" onchange="updateVal('resSelect','resVal','px')">
                    <option value="1920">1080p</option>
                    <option value="1280" selected>720p</option>
                    <option value="640">480p</option>
                </select>
            </div>

            <div class="opt">
                <label>2. Processing Scale</label>
                <span id="scaleVal" class="val-display">1.5x</span>
                <select id="chunkSelect" onchange="updateVal('chunkSelect','scaleVal','x')">
                    <option value="1">1.0x</option>
                    <option value="1.5" selected>1.5x</option>
                    <option value="2.5">2.5x</option>
                </select>
            </div>

            <div class="opt">
                <label>3. Skin Detail</label>
                <span id="blurVal" class="val-display">5px</span>
                <select id="blurSelect" onchange="updateVal('blurSelect','blurVal','px')">
                    <option value="3">3px</option>
                    <option value="5" selected>5px</option>
                    <option value="7">7px</option>
                </select>
            </div>

            <button id="bootBtn" disabled onclick="bootApp()">BOOT SYSTEM</button>
            <p id="status" class="status-bar">CONNECTING TO WORKER...</p>
        </div>
    </div>

    <div id="fps-tag">FPS: --</div>
    <div id="timer">7</div>
    <video id="webcam" autoplay playsinline></video>
    <canvas id="outputCanvas"></canvas>

    <script>
        function updateVal(sid, vid, unit) {
            document.getElementById(vid).innerText = document.getElementById(sid).value + unit;
        }

        const video = document.getElementById('webcam');
        const canvas = document.getElementById('outputCanvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        const offCanvas = document.createElement('canvas');
        const offCtx = offCanvas.getContext('2d', { willReadFrequently: true });
        const bootBtn = document.getElementById('bootBtn');
        const statusEl = document.getElementById('status');
        
        let worker, isProcessing = false, currentFacingMode = "user";
        let frames = 0, lastTime = performance.now(), lastFrameTime = 0;
        let scale, blur, k, sense, width;

        worker = new Worker('./worker.js');
        worker.onmessage = (e) => {
            if (e.data === "READY") {
                statusEl.innerText = "CORE ENGINE READY";
                statusEl.style.color = "#0f0";
                bootBtn.disabled = false;
            } else {
                ctx.putImageData(e.data, 0, 0);
                isProcessing = false;
                frames++;
            }
        };

        async function startCamera(mode) {
            currentFacingMode = mode;
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { width: { ideal: width }, facingMode: currentFacingMode }
            });
            video.srcObject = stream;
        }

        async function bootApp() {
            scale = parseFloat(document.getElementById('chunkSelect').value);
            blur = parseInt(document.getElementById('blurSelect').value);
            width = parseInt(document.getElementById('resSelect').value);
            currentFacingMode = document.getElementById('camSelect').value;
            
            if (document.documentElement.requestFullscreen) await document.documentElement.requestFullscreen();
            
            await startCamera(currentFacingMode);

            video.onloadedmetadata = () => {
                const w = video.videoWidth / scale;
                const h = video.videoHeight / scale;
                canvas.width = offCanvas.width = w;
                canvas.height = offCanvas.height = h;
                document.getElementById('dashboard').style.display = 'none';
                canvas.style.display = 'block';
                // Note: FPS starts hidden, 2 taps to show
                requestAnimationFrame(loop);
            };
        }

        function loop() {
            const now = performance.now();
            if (now - lastFrameTime >= 40 && !isProcessing) {
                isProcessing = true;
                lastFrameTime = now;
                offCtx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imgData = offCtx.getImageData(0, 0, canvas.width, canvas.height);
                
                // Note: Mirroring only applied if using front camera
                worker.postMessage({
                    img: imgData, 
                    blur, 
                    kSize: 5, 
                    sense: 0.9, 
                    isFront: (currentFacingMode === "user")
                }, [imgData.data.buffer]);
                
                if (now - lastTime >= 1000) {
                    document.getElementById('fps-tag').innerText = `FPS: ${frames}`;
                    frames = 0; lastTime = now;
                }
            }
            requestAnimationFrame(loop);
        }

        // Gesture Logic
        let tapCount = 0, tapTimer;
        window.addEventListener('touchstart', (e) => {
            tapCount++;
            clearTimeout(tapTimer);
            tapTimer = setTimeout(() => {
                if (tapCount === 2) {
                    const tag = document.getElementById('fps-tag');
                    tag.style.display = (tag.style.display === 'none' ? 'block' : 'none');
                }
                if (tapCount === 3) startSnapshot();
                if (tapCount === 4) flipCamera();
                tapCount = 0;
            }, 300);
        });

        async function flipCamera() {
            const newMode = (currentFacingMode === "user" ? "environment" : "user");
            await startCamera(newMode);
        }

        function startSnapshot() {
            let count = 7;
            const timerEl = document.getElementById('timer');
            timerEl.style.display = 'block';
            timerEl.innerText = count;
            const countdown = setInterval(() => {
                timerEl.innerText = --count;
                if (count === 0) {
                    clearInterval(countdown);
                    timerEl.style.display = 'none';
                    const link = document.createElement('a');
                    link.download = `laplacian_snap.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                }
            }, 1000);
        }
    </script>
</body>
</html>
