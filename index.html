<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>Laplacian Pro Dashboard</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; color: #0f0; font-family: 'Courier New', monospace; overflow: hidden; }
        
        /* Dashboard Overlay */
        #launcher {
            position: fixed; inset: 0; background: #0a0a0a; z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; text-align: left;
        }

        .config-box { background: #1a1a1a; padding: 25px; border: 1px solid #0f0; border-radius: 15px; width: 90%; max-width: 400px; box-shadow: 0 0 20px rgba(0,255,0,0.2); }
        
        .option { margin-bottom: 20px; }
        label { display: block; font-size: 12px; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        select, input { width: 100%; background: #000; color: #0f0; border: 1px solid #0f0; padding: 10px; border-radius: 5px; }

        #startBtn { 
            width: 100%; background: #0f0; color: #000; border: none; padding: 18px; 
            font-size: 1.2rem; font-weight: bold; cursor: pointer; border-radius: 10px; margin-top: 10px;
        }

        #startBtn:disabled { background: #050; color: #555; cursor: wait; }

        /* Fullscreen View */
        canvas { position: absolute; inset: 0; width: 100vw; height: 100vh; object-fit: cover; image-rendering: pixelated; z-index: 1; display: none; }
        #webcam { display: none; }
        #exit-hint { position: fixed; bottom: 10px; width: 100%; text-align: center; color: rgba(0,255,0,0.3); font-size: 10px; z-index: 10; pointer-events: none; display: none; }
    </style>
</head>
<body>

    <div id="launcher">
        <h2 style="margin-bottom: 5px;">SYSTEM CONFIG</h2>
        <p id="loading-status" style="margin-bottom: 20px; font-size: 10px; color: #888;">DOWNLOAD PIXELS...</p>
        
        <div class="config-box">
            <div class="option">
                <label>Input Quality (Camera)</label>
                <select id="cameraRes">
                    <option value="1920">1080p (True HD)</option>
                    <option value="1280">720p (High)</option>
                    <option value="640" selected>480p (Fast)</option>
                </select>
            </div>

            <div class="option">
                <label>Processing Scale (Smoothness)</label>
                <select id="procScale">
                    <option value="160">Turbo (Highest FPS)</option>
                    <option value="320" selected>Balanced (Standard)</option>
                    <option value="480">Quality (Lower FPS)</option>
                </select>
            </div>

            <div class="option">
                <label>Edge Thickness</label>
                <input type="range" id="thick" min="1" max="7" step="2" value="3">
            </div>

            <button id="startBtn" disabled onclick="goLive()">BOOT SYSTEM</button>
        </div>
    </div>

    <div id="exit-hint">DOUBLE TAP TO EXIT FULLSCREEN</div>
    <video id="webcam" autoplay playsinline></video>
    <canvas id="outputCanvas"></canvas>

    <script>
        // Global Settings to be read by Python
        window.CONFIG = { camW: 640, procW: 320, k: 3 };

        async function goLive() {
            window.CONFIG.camW = parseInt(document.getElementById('cameraRes').value);
            window.CONFIG.procW = parseInt(document.getElementById('procScale').value);
            window.CONFIG.k = parseInt(document.getElementById('thick').value);

            // Trigger Fullscreen
            const doc = document.documentElement;
            if (doc.requestFullscreen) doc.requestFullscreen();
            else if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();

            document.getElementById('launcher').style.display = 'none';
            document.getElementById('outputCanvas').style.display = 'block';
            document.getElementById('exit-hint').style.display = 'block';

            // Start Camera
            const video = document.getElementById('webcam');
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { width: {ideal: window.CONFIG.camW}, facingMode: "user" }, 
                audio: false 
            });
            video.srcObject = stream;
        }

        function pythonReady() {
            document.getElementById('loading-status').innerText = "CORE ENGINE LOADED";
            document.getElementById('startBtn').disabled = false;
        }

        // Exit fullscreen on double tap
        window.addEventListener('dblclick', () => {
            if (document.fullscreenElement) document.exitFullscreen();
        });
    </script>

    <script type="py" config='{"packages": ["opencv-python", "numpy"]}'>
        import cv2
        import numpy as np
        import time
        from js import document, window, requestAnimationFrame, pythonReady
        from pyodide.ffi import create_proxy

        pythonReady()

        video = document.getElementById("webcam")
        canvas = document.getElementById("outputCanvas")
        ctx = canvas.getContext("2d")

        def loop(t):
            if video.videoWidth > 0:
                # Use settings from the Dashboard
                target_w = window.CONFIG.procW
                target_h = int(video.videoHeight * (target_w / video.videoWidth))
                
                if canvas.width != target_w:
                    canvas.width = target_w
                    canvas.height = target_h
                
                # Draw small to save CPU
                ctx.drawImage(video, 0, 0, target_w, target_h)
                img_data = ctx.getImageData(0, 0, target_w, target_h)
                
                # Fast processing
                frame = np.frombuffer(img_data.data.to_py(), dtype=np.uint8).reshape((target_h, target_w, 4))
                frame = cv2.flip(frame, 1)

                # Core Logic
                bgr = cv2.cvtColor(frame, cv2.COLOR_RGBA2BGR)
                gray = cv2.cvtColor(bgr, cv2.COLOR_BGR2GRAY)
                blurred = cv2.medianBlur(gray, 3) 
                
                edges = cv2.Laplacian(blurred, cv2.CV_8U, ksize=window.CONFIG.k)
                _, thresh = cv2.threshold(edges, 40, 255, cv2.THRESH_BINARY)
                
                # Speed hack: bitwise_and for color masking
                mask = cv2.bitwise_and(bgr, bgr, mask=thresh)

                res_rgba = cv2.cvtColor(mask, cv2.COLOR_BGR2RGBA)
                img_ptr = window.ImageData.new(window.Uint8ClampedArray.new(res_rgba.tobytes()), target_w, target_h)
                ctx.putImageData(img_ptr, 0, 0)

            requestAnimationFrame(create_proxy(loop))

        loop(0)
    </script>
</body>
</html>
